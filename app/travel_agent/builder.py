from langchain_anthropic import ChatAnthropic
from langgraph.graph import END, StateGraph, START
from pydantic import SecretStr

from .base_models import (CompleteOrEscalate, ToFlightBookingAssistant,
                                      ToBookCarRental, ToHotelBookingAssistant, ToBookExcursion)

from .prompts import (book_hotel_prompt, book_car_rental_prompt, book_excursion_prompt,
                                  flight_booking_prompt, primary_assistant_prompt)

from .routes import route_primary_assistant
from .tools.cars import search_car_rentals, book_car_rental, update_car_rental, cancel_car_rental

from .tools.excursions import (search_trip_recommendations,
                                           book_excursion, update_excursion, cancel_excursion)

from .tools.flights import (search_flights, update_ticket_to_new_flight, cancel_ticket,
                                        fetch_user_flight_information)

from .tools.hotels import search_hotels, book_hotel, update_hotel, cancel_hotel
# from .tools.retriever import lookup_policy
from .utilities import State, Assistant, create_entry_node, create_tool_node_with_fallback, pop_dialog_state
from .routes import route_to_workflow, route_update_flight, route_book_car_rental, route_book_hotel, \
    route_book_excursion


def get_builder(anthropic_api_key: SecretStr):
    llm = ChatAnthropic(model="claude-3-5-sonnet-20241022", temperature=1, anthropic_api_key=anthropic_api_key)

    update_flight_safe_tools = [search_flights]
    update_flight_sensitive_tools = [update_ticket_to_new_flight, cancel_ticket]
    update_flight_tools = update_flight_safe_tools + update_flight_sensitive_tools
    update_flight_runnable = flight_booking_prompt | llm.bind_tools(
        update_flight_tools + [CompleteOrEscalate]
    )

    book_hotel_safe_tools = [search_hotels]
    book_hotel_sensitive_tools = [book_hotel, update_hotel, cancel_hotel]
    book_hotel_tools = book_hotel_safe_tools + book_hotel_sensitive_tools
    book_hotel_runnable = book_hotel_prompt | llm.bind_tools(
        book_hotel_tools + [CompleteOrEscalate]
    )

    book_car_rental_safe_tools = [search_car_rentals]
    book_car_rental_sensitive_tools = [
        book_car_rental,
        update_car_rental,
        cancel_car_rental,
    ]
    book_car_rental_tools = book_car_rental_safe_tools + book_car_rental_sensitive_tools
    book_car_rental_runnable = book_car_rental_prompt | llm.bind_tools(
        book_car_rental_tools + [CompleteOrEscalate]
    )

    book_excursion_safe_tools = [search_trip_recommendations]
    book_excursion_sensitive_tools = [book_excursion, update_excursion, cancel_excursion]
    book_excursion_tools = book_excursion_safe_tools + book_excursion_sensitive_tools
    book_excursion_runnable = book_excursion_prompt | llm.bind_tools(
        book_excursion_tools + [CompleteOrEscalate]
    )

    primary_assistant_tools = [
        search_flights,
        # lookup_policy,
    ]
    assistant_runnable = primary_assistant_prompt | llm.bind_tools(
        primary_assistant_tools
        + [
            ToFlightBookingAssistant,
            ToBookCarRental,
            ToHotelBookingAssistant,
            ToBookExcursion,
        ]
    )

    builder = StateGraph(State)

    def user_info(state: State):
        return {"user_info": fetch_user_flight_information.invoke({})}

    builder.add_node("fetch_user_info", user_info)
    builder.add_edge(START, "fetch_user_info")

    # Flight booking assistant
    builder.add_node(
        "enter_update_flight",
        create_entry_node("Flight Updates & Booking Assistant", "update_flight"),
    )
    builder.add_node("update_flight", Assistant(update_flight_runnable))
    builder.add_edge("enter_update_flight", "update_flight")
    builder.add_node(
        "update_flight_sensitive_tools",
        create_tool_node_with_fallback(update_flight_sensitive_tools),
    )
    builder.add_node(
        "update_flight_safe_tools",
        create_tool_node_with_fallback(update_flight_safe_tools),
    )

    builder.add_edge("update_flight_sensitive_tools", "update_flight")
    builder.add_edge("update_flight_safe_tools", "update_flight")
    builder.add_conditional_edges(
        "update_flight",
        route_update_flight,
        ["update_flight_sensitive_tools", "update_flight_safe_tools", "leave_skill", END],
    )

    builder.add_node("leave_skill", pop_dialog_state)
    builder.add_edge("leave_skill", "primary_assistant")

    builder.add_node(
        "enter_book_car_rental",
        create_entry_node("Car Rental Assistant", "book_car_rental"),
    )
    builder.add_node("book_car_rental", Assistant(book_car_rental_runnable))
    builder.add_edge("enter_book_car_rental", "book_car_rental")
    builder.add_node(
        "book_car_rental_safe_tools",
        create_tool_node_with_fallback(book_car_rental_safe_tools),
    )
    builder.add_node(
        "book_car_rental_sensitive_tools",
        create_tool_node_with_fallback(book_car_rental_sensitive_tools),
    )

    builder.add_edge("book_car_rental_sensitive_tools", "book_car_rental")
    builder.add_edge("book_car_rental_safe_tools", "book_car_rental")
    builder.add_conditional_edges(
        "book_car_rental",
        route_book_car_rental,
        [
            "book_car_rental_safe_tools",
            "book_car_rental_sensitive_tools",
            "leave_skill",
            END,
        ],
    )

    builder.add_node(
        "enter_book_hotel", create_entry_node("Hotel Booking Assistant", "book_hotel")
    )
    builder.add_node("book_hotel", Assistant(book_hotel_runnable))
    builder.add_edge("enter_book_hotel", "book_hotel")
    builder.add_node(
        "book_hotel_safe_tools",
        create_tool_node_with_fallback(book_hotel_safe_tools),
    )
    builder.add_node(
        "book_hotel_sensitive_tools",
        create_tool_node_with_fallback(book_hotel_sensitive_tools),
    )

    builder.add_edge("book_hotel_sensitive_tools", "book_hotel")
    builder.add_edge("book_hotel_safe_tools", "book_hotel")
    builder.add_conditional_edges(
        "book_hotel",
        route_book_hotel,
        ["leave_skill", "book_hotel_safe_tools", "book_hotel_sensitive_tools", END],
    )

    # Excursion assistant
    builder.add_node(
        "enter_book_excursion",
        create_entry_node("Trip Recommendation Assistant", "book_excursion"),
    )
    builder.add_node("book_excursion", Assistant(book_excursion_runnable))
    builder.add_edge("enter_book_excursion", "book_excursion")
    builder.add_node(
        "book_excursion_safe_tools",
        create_tool_node_with_fallback(book_excursion_safe_tools),
    )
    builder.add_node(
        "book_excursion_sensitive_tools",
        create_tool_node_with_fallback(book_excursion_sensitive_tools),
    )

    builder.add_edge("book_excursion_sensitive_tools", "book_excursion")
    builder.add_edge("book_excursion_safe_tools", "book_excursion")
    builder.add_conditional_edges(
        "book_excursion",
        route_book_excursion,
        ["book_excursion_safe_tools", "book_excursion_sensitive_tools", "leave_skill", END],
    )

    builder.add_node("primary_assistant", Assistant(assistant_runnable))
    builder.add_node(
        "primary_assistant_tools", create_tool_node_with_fallback(primary_assistant_tools)
    )
    builder.add_conditional_edges(
        "primary_assistant",
        route_primary_assistant,
        [
            "enter_update_flight",
            "enter_book_car_rental",
            "enter_book_hotel",
            "enter_book_excursion",
            "primary_assistant_tools",
            END,
        ],
    )
    builder.add_edge("primary_assistant_tools", "primary_assistant")

    builder.add_conditional_edges("fetch_user_info", route_to_workflow)

    return builder
